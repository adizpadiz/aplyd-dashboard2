<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplyd — Roles & Employers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --line:#eaecef;
      --pill:#f7f8fa;
      --shadow:0 1px 2px rgba(16,24,40,.04), 0 10px 30px rgba(16,24,40,.06);

      --primary-start:#40a9ff;
      --primary-end:#22c55e;
      --neon:#c8ff3a;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius:16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card:#0f172a;
        --text:#f8fafc;
        --muted:#9aa4b2;
        --line:#1f2937;
        --pill:#0b1326;
        --shadow:none;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Layout ===== */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100dvh;
    }
    aside{
      background:var(--card);
      border-right:1px solid var(--line);
      padding:20px 16px;
      display:flex; flex-direction:column; gap:16px;
    }
    .brand{
      display:flex; align-items:center; gap:.5rem;
      font-weight:800; font-size:24px; letter-spacing:.2px;
      font-family: ui-serif, Georgia, serif;
    }
    .brand .dot{ color:var(--neon) }

    nav{ display:grid; gap:6px }
    .nav-btn{
      display:flex; gap:10px; align-items:center;
      padding:12px; border-radius:12px; text-decoration:none; color:inherit;
      border:1px solid transparent;
      outline-offset:2px;
    }
    .nav-btn.active{ background:#0b1220; color:#fff; border-color:#0b1220 }
    .nav-btn svg{ width:18px; height:18px }

    .beta-cta{
      margin-top:auto;
      border-radius:999px;
      padding:12px 16px;
      font-weight:700;
      text-align:center;
      background:linear-gradient(90deg,var(--primary-start),var(--primary-end));
      color:#fff; text-decoration:none;
      box-shadow:0 10px 26px rgba(34,197,94,.25), 0 4px 12px rgba(64,169,255,.22);
    }
    .small-note{ text-align:center; color:var(--muted); font-size:12px }

    header{
      position:sticky; top:0; z-index:5;
      padding:14px 24px;
      background:var(--card);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .hello{ display:flex; align-items:center; gap:10px }
    .hi{ background:var(--pill); border:1px solid var(--line); padding:10px 14px; border-radius:12px; color:var(--muted); font-weight:600 }
    .quick{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:var(--card);
      padding:8px 12px; border-radius:999px; font-weight:600;
    }
    .btn{
      border:1px solid var(--line); background:var(--card); padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{
      color:#fff; border:none;
      background:linear-gradient(90deg,var(--primary-start),var(--primary-end));
      box-shadow:0 6px 18px rgba(34,197,94,.25), 0 2px 8px rgba(64,169,255,.22);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed }

    main{ padding:24px; display:grid; gap:18px }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow) }

    .hero{ padding:32px; position:relative; overflow:hidden }
    .hero h1{ margin:0 0 8px 0; font-size:46px; font-weight:800 }
    .hero p{ color:var(--muted); margin:0; max-width:60ch }
    .hero::after{
      content:""; position:absolute; inset:auto -20% -35% -20%; height:240px;
      background:radial-gradient(80% 60% at 50% 0%, rgba(200,255,58,.45) 0%, rgba(200,255,58,.18) 40%, transparent 70%);
      filter:blur(30px); pointer-events:none;
    }

    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:18px }
    .side{ display:grid; grid-template-columns:1fr; gap:18px }
    .side .tile{ padding:20px }

    .section{ padding:8px 0 }
    .section h2{
      font-size:20px; margin:10px; display:flex; align-items:center; justify-content:space-between;
    }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; padding:8px;
    }
    .input, select{
      border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:var(--card); color:inherit;
      min-width:160px;
    }
    .range{ display:flex; align-items:center; gap:10px }
    .range input[type=range]{ width:180px }

    /* Employers + Roles */
    .panes{ display:grid; grid-template-columns: 300px 1fr; gap:18px }
    .list{
      display:grid; gap:10px; padding:10px;
      max-height:540px; overflow:auto;
    }
    .row{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line); background:var(--card); padding:10px 12px; border-radius:12px;
      cursor:pointer;
    }
    .row.selected{ outline:2px solid #1d4ed8; outline-offset:0 }
    .emblem{ width:32px; height:32px; border-radius:8px; display:grid; place-items:center; font-weight:800; color:#1849a9; background:#eef7ff }
    .row small{ color:var(--muted) }
    .count{ margin-left:auto; font-weight:700; color:var(--muted) }

    .roles{ display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:18px; padding:8px }
    .job{
      border:1px solid var(--line); border-radius:16px; background:var(--card); padding:16px; display:grid; gap:12px; position:relative;
    }
    .save{ position:absolute; right:12px; top:12px; border:none; background:transparent; cursor:pointer }
    .title h4{ margin:0; font-size:15px }
    .title small{ color:var(--muted) }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; color:#4b5563 }
    .meta span{
      display:inline-flex; gap:6px; align-items:center;
      background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px;
    }
    .fit{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px dashed var(--line); border-radius:12px; background:color-mix(in lab, var(--pill) 80%, transparent);
    }
    .fit .score{ font-weight:900 }
    .fit[data-level="high"] .score{ color:var(--ok) }
    .fit[data-level="med"] .score{ color:var(--warn) }
    .fit[data-level="low"] .score{ color:var(--bad) }

    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; background:var(--pill); border:1px solid var(--line); font-weight:600; color:#374151;
    }
    .status[data-s="approved"]{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46 }
    .status[data-s="applied"]{ background:#eef7ff; border-color:#cfe5ff; color:#1849a9 }
    .status[data-s="interview"]{ background:#fff7ed; border-color:#fed7aa; color:#9a3412 }
    .status[data-s="rejected"]{ background:#fef2f2; border-color:#fecaca; color:#991b1b }

    /* Modal */
    dialog{ border:none; border-radius:16px; padding:0; width:min(720px,96vw); box-shadow:0 24px 60px rgba(0,0,0,.18); background:var(--card); color:inherit }
    .modal{ padding:18px; display:grid; gap:12px }
    .modal header{ display:flex; justify-content:space-between; align-items:center }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    textarea{ min-height:120px; padding:12px; border-radius:12px; border:1px solid var(--line); resize:vertical; background:var(--card); color:inherit }

    .toast{ position:fixed; right:18px; bottom:18px; display:grid; gap:8px; z-index:9999 }
    .toast .t{ background:#0b1220; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); animation:slideIn .2s ease-out }
    @keyframes slideIn{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

    /* Responsive */
    @media (max-width:1160px){
      .grid{ grid-template-columns:1fr }
      .panes{ grid-template-columns:1fr }
      .roles{ grid-template-columns:repeat(2,minmax(240px,1fr)) }
    }
    @media (max-width:760px){
      .app{ grid-template-columns:1fr }
      aside{ display:none }
      .roles{ grid-template-columns:1fr }
      .hero h1{ font-size:36px }
    }

    /* Neon glow footer background */
    #aplyd-glow{
      position:fixed; left:0; right:0; bottom:-18vh; height:42vh;
      background: radial-gradient(60% 80% at 50% 0%, rgba(200,255,58,.45), rgba(200,255,58,.12) 55%, transparent 70%);
      filter: blur(26px); z-index:0; pointer-events:none;
    }
    .app{ position:relative; z-index:1 }
  </style>
</head>
<body>
<div id="aplyd-glow" aria-hidden="true"></div>

<div class="app">
  <!-- ===== Sidebar ===== -->
  <aside>
    <div class="brand">Aplyd<span class="dot">•</span></div>

    <nav aria-label="Primary">
      <a class="nav-btn active" href="#" aria-current="page">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10.5 1.5a1.5 1.5 0 0 1 3 0V3h2.25A3.75 3.75 0 0 1 19.5 6.75V21a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 5.5 21V6.75A3.75 3.75 0 0 1 9.25 3H11.5V1.5zM9.25 4.5A2.25 2.25 0 0 0 7 6.75V21h10V6.75A2.25 2.25 0 0 0 14.75 4.5h-5.5z"/></svg>
        Dashboard
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25V18.75A2.25 2.25 0 0 1 18.75 21H5.25A2.25 2.25 0 0 1 3 18.75V5.25zM5.25 4.5a.75.75 0 0 0-.75.75V9h15V5.25a.75.75 0 0 0-.75-.75H5.25z"/></svg>
        Roles
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 3.75A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6zM6 5.25h12a.75.75 0 0 1 .75.75v12a.75.75 0 0 1-.75.75H6a.75.75 0 0 1-.75-.75V6a.75.75 0 0 1 .75-.75z"/></svg>
        Applications
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 12a5.25 5.25 0 1 0 0-10.5A5.25 5.25 0 0 0 12 12zm-8.25 9a8.25 8.25 0 1 1 16.5 0V22.5h-16.5V21z"/></svg>
        Profile
      </a>
    </nav>

    <a class="beta-cta" href="https://aplyd.com/beta" target="_blank" rel="noopener">Sign up for Beta</a>
    <div class="small-note">Get early access and updates ✨</div>
  </aside>

  <!-- ===== Content ===== -->
  <div style="display:flex;flex-direction:column;min-width:0">
    <header>
      <div class="hello">
        <div class="hi" role="status" aria-live="polite">Hi, Candidate 👋</div>
      </div>
      <div class="quick">
        <label class="chip">Agent Mode
          <input id="agentToggle" type="checkbox" aria-label="Toggle Agent Mode"/>
        </label>
        <div class="range">
          <label for="threshold"><b>Auto-apply ≥</b></label>
          <input id="threshold" type="range" min="50" max="100" step="1" />
          <span id="thresholdVal" class="chip" aria-live="polite">90</span>
        </div>
        <button class="btn primary" id="syncBtn">Refresh</button>
      </div>
    </header>

    <main>
      <!-- Hero -->
      <section class="card hero" aria-label="Intro">
        <h1>Find roles at top employers</h1>
        <p>Browse employers, inspect roles, and apply in a click. Aplyd keeps your pipeline tidy — from approved to interview.</p>
      </section>

      <!-- Employers + Roles -->
      <section class="card section" aria-labelledby="employersHeading">
        <h2 id="employersHeading">
          Employers & roles
          <small><a href="#" id="clearFilters" style="color:var(--muted); text-decoration:none">Clear filters</a></small>
        </h2>

        <div class="toolbar" role="region" aria-label="Filters">
          <input class="input" id="q" placeholder="Search role title, employer…" aria-label="Search"/>
          <select id="loc" aria-label="Location filter">
            <option value="">All locations</option>
            <option>Remote</option>
            <option>Onsite</option>
            <option>Hybrid</option>
          </select>
          <select id="type" aria-label="Type filter">
            <option value="">Any type</option>
            <option>Full-time</option>
            <option>Contract</option>
            <option>Part-time</option>
            <option>Internship</option>
          </select>
          <select id="vis" aria-label="Visibility filter">
            <option value="">Visibility (any)</option>
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="draft">Draft</option>
          </select>
          <select id="resumePicker" aria-label="Default resume"></select>
        </div>

        <div class="panes">
          <!-- Employers -->
          <div class="card" style="padding:8px">
            <div class="list" id="employerList" role="listbox" aria-label="Employers"></div>
          </div>

          <!-- Roles -->
          <div>
            <div id="roleList" class="roles" aria-live="polite"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- ===== Apply Modal ===== -->
<dialog id="applyModal">
  <form method="dialog" class="modal" id="applyForm">
    <header>
      <h3 style="margin:0">Apply — <span id="mTitle"></span> at <span id="mCompany" style="color:var(--muted)"></span></h3>
      <button class="btn" value="cancel" aria-label="Close">✕</button>
    </header>

    <div class="grid-2">
      <label>Full name
        <input class="input" id="mName" required placeholder="Your name"/>
      </label>
      <label>Email
        <input class="input" id="mEmail" type="email" required placeholder="you@email.com"/>
      </label>
    </div>

    <div class="grid-2">
      <label>Resume
        <select id="mResume" class="input" required></select>
      </label>
      <label>Cover Letter
        <select id="mHasCover" class="input">
          <option value="draft">Create draft</option>
          <option value="none">No cover letter</option>
        </select>
      </label>
    </div>

    <label>Cover Letter Text
      <textarea id="mCoverText" placeholder="Why you're a great fit…"></textarea>
    </label>

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" value="cancel">Cancel</button>
      <button id="applyConfirm" class="btn primary" value="apply">Apply</button>
    </div>
  </form>
</dialog>

<div id="toasts" class="toast" role="status" aria-live="polite"></div>

<script>
/* =============================
   Aplyd — Roles & Employers
   Clean file, no backend needed
   ============================= */

/* ---------- Utilities ---------- */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const fmtMoney = (s) => s || "—";
const timeAgo = (ts) => {
  if (!ts) return "";
  const d = new Date(ts), diff = (Date.now() - d.getTime())/1000;
  const units = [["yr",31536000],["mo",2592000],["d",86400],["h",3600]];
  for (const [u,s] of units) if (diff >= s) return `${Math.floor(diff/s)} ${u} ago`;
  return "just now";
};
const level = (v)=> v>=90 ? "high" : v>=75 ? "med" : "low";
const svgBookmark = (on=false)=> on
  ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 2.25A2.25 2.25 0 0 0 3.75 4.5v17.25l8.25-4.5 8.25 4.5V4.5A2.25 2.25 0 0 0 18.75 2.25H6z"/></svg>'
  : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true"><path d="M6 2.25h12A2.25 2.25 0 0 1 20.25 4.5v17.25l-8.25-4.5-8.25 4.5V4.5A2.25 2.25 0 0 1 6 2.25z"/></svg>';
const toast = (msg) => {
  const host = $("#toasts");
  const div = document.createElement("div");
  div.className = "t";
  div.textContent = msg;
  host.appendChild(div);
  setTimeout(()=>div.remove(), 3200);
};
const escapeHtml = (s)=> (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

/* ---------- State ---------- */
const state = {
  resumes: [],
  employers: [],
  roles: [],
  applications: [], // {id, role_id, employer_id, status, fit_score, resume_id, applied_at, name, email, cover}
  bookmarks: new Set(JSON.parse(localStorage.getItem("aplyd.bookmarks")||"[]")),
  agent: JSON.parse(localStorage.getItem("aplyd.agent")||"false"),
  threshold: parseInt(localStorage.getItem("aplyd.threshold")||"90",10),
  selectedEmployer: null
};

/* ---------- Seed (mock data) ---------- */
function seedData(){
  state.resumes = [
    { id:"cv-1", title:"General Resume (PDF)", url:"#", created_at: new Date().toISOString() },
    { id:"cv-2", title:"Backend-leaning", url:"#", created_at: new Date(Date.now()-2*864e5).toISOString() },
  ];
  state.employers = [
    { id:"em-1", name:"Airtable",    slug:"airtable",    about:"Tools for connected apps.", color:"#3b82f6" },
    { id:"em-2", name:"Linear",      slug:"linear",      about:"Issue tracking re-imagined.", color:"#0b1220" },
    { id:"em-3", name:"Figma",       slug:"figma",       about:"Design for teams.", color:"#111827" },
    { id:"em-4", name:"Klarna",      slug:"klarna",      about:"Smoooth payments.", color:"#ef4444" },
    { id:"em-5", name:"Vercel",      slug:"vercel",      about:"Develop. Preview. Ship.", color:"#111827" },
  ];
  const now = Date.now();
  state.roles = [
    { id:"r-1", employer_id:"em-1", title:"Senior Backend Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$160–190k + equity", posted_at:new Date(now-8.6e6).toISOString(), tags:["Python","FastAPI","Postgres"] },
    { id:"r-2", employer_id:"em-5", title:"Frontend Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$150–180k", posted_at:new Date(now-2.2e7).toISOString(), tags:["React","Next.js","TypeScript"] },
    { id:"r-3", employer_id:"em-2", title:"Full-stack Engineer", location:"Hybrid", type:"Full-time", visibility:"public", salary:"$140–170k", posted_at:new Date(now-3.3e7).toISOString(), tags:["TypeScript","Node","GraphQL"] },
    { id:"r-4", employer_id:"em-3", title:"Design Systems Engineer", location:"Remote", type:"Contract", visibility:"private", salary:"$95–120/hr", posted_at:new Date(now-4.5e7).toISOString(), tags:["Web Components","TS","Accessibility"] },
    { id:"r-5", employer_id:"em-4", title:"Payments Platform Engineer", location:"Onsite", type:"Full-time", visibility:"draft", salary:"Competitive", posted_at:new Date(now-7.1e7).toISOString(), tags:["Java","Kafka","AWS"] },
    { id:"r-6", employer_id:"em-1", title:"Data Platform Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$170–200k", posted_at:new Date(now-1.5e7).toISOString(), tags:["Python","Spark","Airflow"] },
    { id:"r-7", employer_id:"em-3", title:"Prod Infra Engineer", location:"Hybrid", type:"Full-time", visibility:"public", salary:"$160–185k", posted_at:new Date(now-8.8e6).toISOString(), tags:["Kubernetes","Go","Observability"] },
  ];

  // Load applications from localStorage, or create one example
  const saved = JSON.parse(localStorage.getItem("aplyd.applications")||"[]");
  state.applications = saved.length ? saved : [
    { id:"a-1", role_id:"r-2", employer_id:"em-5", status:"applied", fit_score:92, resume_id:"cv-2", applied_at:new Date().toISOString(), name:"", email:"", cover:"" }
  ];
}

/* ---------- Persistence ---------- */
function persist(){
  localStorage.setItem("aplyd.bookmarks", JSON.stringify([...state.bookmarks]));
  localStorage.setItem("aplyd.agent", JSON.stringify(state.agent));
  localStorage.setItem("aplyd.threshold", String(state.threshold));
  localStorage.setItem("aplyd.applications", JSON.stringify(state.applications));
}

/* ---------- Init ---------- */
(function init(){
  seedData();
  $("#agentToggle").checked = state.agent;
  $("#threshold").value = state.threshold;
  $("#thresholdVal").textContent = state.threshold;

  // events
  $("#threshold").addEventListener("input", e=>{
    state.threshold = +e.target.value;
    $("#thresholdVal").textContent = state.threshold;
    persist(); renderRoles();
  });
  $("#agentToggle").addEventListener("change", e=>{
    state.agent = e.target.checked; persist();
    toast(state.agent ? "Agent Mode enabled ✔️" : "Agent Mode disabled");
    renderRoles();
  });
  $("#q").addEventListener("input", renderRoles);
  $("#loc").addEventListener("change", renderRoles);
  $("#type").addEventListener("change", renderRoles);
  $("#vis").addEventListener("change", renderRoles);
  $("#clearFilters").addEventListener("click", (e)=>{e.preventDefault(); $("#q").value=""; $("#loc").value=""; $("#type").value=""; $("#vis").value=""; renderRoles();});
  $("#syncBtn").addEventListener("click", ()=>{ renderAll(); toast("Refreshed ✔️"); });

  renderAll();
})();

/* ---------- Rendering ---------- */
function renderAll(){
  renderResumePicker($("#resumePicker"));
  renderEmployers();
  renderRoles();
}

function renderResumePicker(selectEl){
  const opts = [`<option value="">Default resume…</option>`]
    .concat(state.resumes.map(r=>`<option value="${r.id}">${escapeHtml(r.title)}</option>`));
  selectEl.innerHTML = opts.join("");
  if (state.resumes[0]) selectEl.value = state.resumes[0].id;
}

function renderEmployers(){
  const host = $("#employerList");
  const counts = state.roles.reduce((m,r)=> (m[r.employer_id]=(m[r.employer_id]||0)+1, m), {});
  host.innerHTML = state.employers.map(e=>{
    const selected = state.selectedEmployer===e.id ? "selected" : "";
    return `<button class="row ${selected}" role="option" aria-selected="${selected?'true':'false'}" data-id="${e.id}" title="${escapeHtml(e.about)}">
      <span class="emblem" style="background:#eef7ff;color:#1849a9">${escapeHtml(e.name[0])}</span>
      <div style="display:grid">
        <b>${escapeHtml(e.name)}</b>
        <small>${escapeHtml(e.about)}</small>
      </div>
      <span class="count">${counts[e.id]||0}</span>
    </button>`;
  }).join("");

  $$("#employerList .row").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      state.selectedEmployer = state.selectedEmployer===id ? null : id;
      renderEmployers(); renderRoles();
    };
  });
}

function appByRole(roleId){ return state.applications.find(a=>a.role_id===roleId); }

function renderRoles(){
  renderResumePicker($("#mResume")); // keep modal picker fresh

  const q = ($("#q").value||"").toLowerCase();
  const loc = $("#loc").value;
  const type = $("#type").value;
  const vis = $("#vis").value;

  const activeEmployer = state.selectedEmployer;

  const roles = state.roles.filter(r=>{
    if (activeEmployer && r.employer_id!==activeEmployer) return false;
    if (q){
      const employer = state.employers.find(e=>e.id===r.employer_id)?.name || "";
      if (!(r.title+" "+employer).toLowerCase().includes(q)) return false;
    }
    if (loc && !(r.location||"").toLowerCase().includes(loc.toLowerCase())) return false;
    if (type && r.type!==type) return false;
    if (vis && r.visibility!==vis) return false;
    return true;
  });

  const host = $("#roleList");
  host.innerHTML = roles.map(r=>{
    const emp = state.employers.find(e=>e.id===r.employer_id);
    const app = appByRole(r.id);
    const isSaved = state.bookmarks.has(r.id);
    const score = app?.fit_score ?? guessFitScore(r);
    const lev = level(score);
    const status = app?.status;

    return `<article class="job" data-id="${r.id}" aria-label="${escapeHtml(r.title)} at ${escapeHtml(emp.name)}">
      <button class="save" title="${isSaved?'Saved':'Save'}" aria-pressed="${isSaved}">${svgBookmark(isSaved)}</button>

      <div class="company">
        <div class="emblem" style="background:#eef7ff;color:#1849a9">${escapeHtml(emp.name[0])}</div>
        <div class="title">
          <h4>${escapeHtml(emp.name)}</h4>
          <small>${escapeHtml(r.title)}</small>
        </div>
      </div>

      <div class="meta">
        <span>📍 ${escapeHtml(r.location)}</span>
        <span>💼 ${escapeHtml(r.type)}</span>
        <span>🕒 ${timeAgo(r.posted_at)}</span>
        <span>💰 ${escapeHtml(fmtMoney(r.salary))}</span>
        ${r.visibility?`<span>👁️ ${escapeHtml(r.visibility)}</span>`:""}
      </div>

      <div>${r.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(" ")}</div>

      <div class="fit" data-level="${lev}">
        <div><b>Fit Score</b></div>
        <div class="score" aria-label="fit score">${score}</div>
        ${state.agent && score>=state.threshold ? '<span class="pill">Auto-apply eligible</span>' : ''}
      </div>

      ${status ? `<div class="status pill" data-s="${status}">${status}</div>` : ""}

      <div class="actions" style="display:flex;gap:8px">
        <button class="btn" data-action="approve">Approve</button>
        <button class="btn primary" data-action="apply" ${status==='applied'?'disabled':''}>
          ${status==='applied'?'Applied':'Apply'}
        </button>
      </div>
    </article>`;
  }).join("");

  // bindings
  $$("#roleList .save").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = e.currentTarget.closest(".job").dataset.id;
      if (state.bookmarks.has(id)) state.bookmarks.delete(id); else state.bookmarks.add(id);
      persist(); renderRoles();
    };
  });
  $$("#roleList [data-action]").forEach(btn=>{
    btn.onclick = onRoleAction;
  });
}

/* ---------- Actions ---------- */
function onRoleAction(e){
  const action = e.currentTarget.dataset.action;
  const id = e.currentTarget.closest(".job").dataset.id;
  const role = state.roles.find(r=>r.id===id);
  const employer = state.employers.find(x=>x.id===role.employer_id);
  const app = appByRole(id);

  if (action==="approve"){
    if (app){ toast("Already in your pipeline."); return; }
    approveRole(role);
  }
  if (action==="apply"){
    openApplyModal(employer, role, app);
  }
}

function approveRole(role){
  const fit = guessFitScore(role);
  const a = {
    id: crypto.randomUUID?.() || "a-"+Math.random().toString(36).slice(2,9),
    role_id: role.id,
    employer_id: role.employer_id,
    status: "approved",
    fit_score: fit,
    resume_id: $("#resumePicker").value || state.resumes[0]?.id || null,
    applied_at: null,
    name:"",
    email:"",
    cover:""
  };
  state.applications.unshift(a);
  persist();
  renderRoles();
  toast("Approved ✔️");

  if (state.agent && fit >= state.threshold){
    const emp = state.employers.find(e=>e.id===role.employer_id);
    openApplyModal(emp, role, a, /*auto*/ true);
  }
}

function openApplyModal(emp, role, app, auto=false){
  const dlg = $("#applyModal");
  $("#mCompany").textContent = emp.name;
  $("#mTitle").textContent = role.title;
  renderResumePicker($("#mResume"));
  $("#mHasCover").value = "draft";
  $("#mCoverText").value = coverDraft(emp, role);
  $("#mName").value = app?.name || "";
  $("#mEmail").value = app?.email || "";

  dlg.showModal();

  $("#applyConfirm").onclick = (ev)=>{
    ev.preventDefault();
    applyNow(emp, role, app);
  };

  if (auto){
    setTimeout(()=>applyNow(emp, role, app, true), 300);
  }
}

function applyNow(emp, role, existingApp, silent=false){
  const name = $("#mName").value.trim();
  const email = $("#mEmail").value.trim();
  const resume_id = $("#mResume").value || state.resumes[0]?.id;
  const wantCover = $("#mHasCover").value === "draft";
  const cover = wantCover ? $("#mCoverText").value.trim() : "";

  const base = existingApp || {
    id: crypto.randomUUID?.() || "a-"+Math.random().toString(36).slice(2,9),
    role_id: role.id,
    employer_id: emp.id,
    status:"approved",
    fit_score: guessFitScore(role),
    resume_id: resume_id,
    applied_at:null,
    name:"",
    email:"",
    cover:""
  };

  const patch = { ...base, status:"applied", applied_at:new Date().toISOString(), name, email, cover, resume_id };

  const idx = state.applications.findIndex(a=>a.id===base.id);
  if (idx>=0) state.applications[idx] = patch; else state.applications.unshift(patch);

  persist();
  renderRoles();
  $("#applyModal").close();
  if (!silent) toast(`Applied to ${emp.name} — ${role.title} 🎯`);
}

/* ---------- Heuristics ---------- */
function guessFitScore(role){
  const t = (role.title||"").toLowerCase();
  let s = 62;
  if (t.includes("frontend")) s+=14;
  if (t.includes("backend")) s+=18;
  if (t.includes("full")) s+=10;
  if ((role.location||"").toLowerCase().includes("remote")) s+=8;
  if ((role.type||"").toLowerCase().includes("full")) s+=4;
  if (role.tags?.some(x=>/typescript|python|java|react|fastapi|graphql|kafka|kubernetes/i.test(x))) s+=6;
  return clamp(Math.round(s), 50, 99);
}

function coverDraft(emp, role){
  return `Dear Hiring Team at ${emp.name},

I'm excited to apply for the ${role.title} role. I have shipped production features across ${role.tags.slice(0,3).join(", ")} and love collaborating across product, design, and infra.

Highlights:
• Built reliable services and focused on performance & DX.
• Pragmatic, test-first approach; accessible, maintainable UI.
• Comfortable with code reviews, pairing, and owning outcomes.

I'd be thrilled to bring that energy to ${emp.name}. Thanks for your time!

Best,
Candidate`;
}

/* ---------- Keyboard niceties ---------- */
document.addEventListener("keydown", (e)=>{
  if (e.key==="Escape") $("#applyModal")?.close?.();
});
</script>
</body>
</html>
