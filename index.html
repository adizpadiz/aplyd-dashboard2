<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplyd ‚Äî Roles & Employers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --line:#eaecef;
      --pill:#f7f8fa;
      --shadow:0 1px 2px rgba(16,24,40,.04), 0 10px 30px rgba(16,24,40,.06);

      --primary-start:#40a9ff;
      --primary-end:#22c55e;
      --neon:#c8ff3a;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius:16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card:#0f172a;
        --text:#f8fafc;
        --muted:#9aa4b2;
        --line:#1f2937;
        --pill:#0b1326;
        --shadow:none;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Layout ===== */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100dvh;
    }
    aside{
      background:var(--card);
      border-right:1px solid var(--line);
      padding:20px 16px;
      display:flex; flex-direction:column; gap:16px;
    }
    .brand{
      display:flex; align-items:center; gap:.5rem;
      font-weight:800; font-size:24px; letter-spacing:.2px;
      font-family: ui-serif, Georgia, serif;
    }
    .brand .dot{ color:var(--neon) }

    nav{ display:grid; gap:6px }
    .nav-btn{
      display:flex; gap:10px; align-items:center;
      padding:12px; border-radius:12px; text-decoration:none; color:inherit;
      border:1px solid transparent;
      outline-offset:2px;
    }
    .nav-btn.active{ background:#0b1220; color:#fff; border-color:#0b1220 }
    .nav-btn svg{ width:18px; height:18px }

    .beta-cta{
      margin-top:auto;
      border-radius:999px;
      padding:12px 16px;
      font-weight:700;
      text-align:center;
      background:linear-gradient(90deg,var(--primary-start),var(--primary-end));
      color:#fff; text-decoration:none;
      box-shadow:0 10px 26px rgba(34,197,94,.25), 0 4px 12px rgba(64,169,255,.22);
    }
    .small-note{ text-align:center; color:var(--muted); font-size:12px }

    header{
      position:sticky; top:0; z-index:5;
      padding:14px 24px;
      background:var(--card);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .hello{ display:flex; align-items:center; gap:10px }
    .hi{ background:var(--pill); border:1px solid var(--line); padding:10px 14px; border-radius:12px; color:var(--muted); font-weight:600 }
    .quick{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:var(--card);
      padding:8px 12px; border-radius:999px; font-weight:600;
    }
    .btn{
      border:1px solid var(--line); background:var(--card); padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{
      color:#fff; border:none;
      background:linear-gradient(90deg,var(--primary-start),var(--primary-end));
      box-shadow:0 6px 18px rgba(34,197,94,.25), 0 2px 8px rgba(64,169,255,.22);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed }

    main{ padding:24px; display:grid; gap:18px }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow) }

    .hero{ padding:32px; position:relative; overflow:hidden }
    .hero h1{ margin:0 0 8px 0; font-size:46px; font-weight:800 }
    .hero p{ color:var(--muted); margin:0; max-width:60ch }
    .hero::after{
      content:""; position:absolute; inset:auto -20% -35% -20%; height:240px;
      background:radial-gradient(80% 60% at 50% 0%, rgba(200,255,58,.45) 0%, rgba(200,255,58,.18) 40%, transparent 70%);
      filter:blur(30px); pointer-events:none;
    }

    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:18px }
    .side{ display:grid; grid-template-columns:1fr; gap:18px }
    .side .tile{ padding:20px }

    .section{ padding:8px 0 }
    .section h2{
      font-size:20px; margin:10px; display:flex; align-items:center; justify-content:space-between;
    }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; padding:8px;
    }
    .input, select{
      border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:var(--card); color:inherit;
      min-width:160px;
    }
    .range{ display:flex; align-items:center; gap:10px }
    .range input[type=range]{ width:180px }

    /* Employers + Roles */
    .panes{ display:grid; grid-template-columns: 300px 1fr; gap:18px }
    .list{
      display:grid; gap:10px; padding:10px;
      max-height:540px; overflow:auto;
    }
    .row{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line); background:var(--card); padding:10px 12px; border-radius:12px;
      cursor:pointer;
    }
    .row.selected{ outline:2px solid #1d4ed8; outline-offset:0 }
    .emblem{ width:32px; height:32px; border-radius:8px; display:grid; place-items:center; font-weight:800; color:#1849a9; background:#eef7ff }
    .row small{ color:var(--muted) }
    .count{ margin-left:auto; font-weight:700; color:var(--muted) }

    .roles{ display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:18px; padding:8px }
    .job{
      border:1px solid var(--line); border-radius:16px; background:var(--card); padding:16px; display:grid; gap:12px; position:relative;
    }
    .save{ position:absolute; right:12px; top:12px; border:none; background:transparent; cursor:pointer }
    .title h4{ margin:0; font-size:15px }
    .title small{ color:var(--muted) }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; color:#4b5563 }
    .meta span{
      display:inline-flex; gap:6px; align-items:center;
      background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px;
    }
    .fit{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px dashed var(--line); border-radius:12px; background:color-mix(in lab, var(--pill) 80%, transparent);
    }
    .fit .score{ font-weight:900 }
    .fit[data-level="high"] .score{ color:var(--ok) }
    .fit[data-level="med"] .score{ color:var(--warn) }
    .fit[data-level="low"] .score{ color:var(--bad) }

    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; background:var(--pill); border:1px solid var(--line); font-weight:600; color:#374151;
    }
    .status[data-s="approved"]{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46 }
    .status[data-s="applied"]{ background:#eef7ff; border-color:#cfe5ff; color:#1849a9 }
    .status[data-s="interview"]{ background:#fff7ed; border-color:#fed7aa; color:#9a3412 }
    .status[data-s="rejected"]{ background:#fef2f2; border-color:#fecaca; color:#991b1b }

    /* Modal */
    dialog{ border:none; border-radius:16px; padding:0; width:min(720px,96vw); box-shadow:0 24px 60px rgba(0,0,0,.18); background:var(--card); color:inherit }
    .modal{ padding:18px; display:grid; gap:12px }
    .modal header{ display:flex; justify-content:space-between; align-items:center }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    textarea{ min-height:120px; padding:12px; border-radius:12px; border:1px solid var(--line); resize:vertical; background:var(--card); color:inherit }

    .toast{ position:fixed; right:18px; bottom:18px; display:grid; gap:8px; z-index:9999 }
    .toast .t{ background:#0b1220; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); animation:slideIn .2s ease-out }
    @keyframes slideIn{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

    /* Responsive */
    @media (max-width:1160px){
      .grid{ grid-template-columns:1fr }
      .panes{ grid-template-columns:1fr }
      .roles{ grid-template-columns:repeat(2,minmax(240px,1fr)) }
    }
    @media (max-width:760px){
      .app{ grid-template-columns:1fr }
      aside{ display:none }
      .roles{ grid-template-columns:1fr }
      .hero h1{ font-size:36px }
    }

    /* Neon glow footer background */
    #aplyd-glow{
      position:fixed; left:0; right:0; bottom:-18vh; height:42vh;
      background: radial-gradient(60% 80% at 50% 0%, rgba(200,255,58,.45), rgba(200,255,58,.12) 55%, transparent 70%);
      filter: blur(26px); z-index:0; pointer-events:none;
    }
    .app{ position:relative; z-index:1 }
  </style>
</head>
<body>
<div id="aplyd-glow" aria-hidden="true"></div>

<div class="app">
  <!-- ===== Sidebar ===== -->
  <aside>
    <div class="brand">Aplyd<span class="dot">‚Ä¢</span></div>

    <nav aria-label="Primary">
      <a class="nav-btn active" href="#" aria-current="page">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10.5 1.5a1.5 1.5 0 0 1 3 0V3h2.25A3.75 3.75 0 0 1 19.5 6.75V21a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 5.5 21V6.75A3.75 3.75 0 0 1 9.25 3H11.5V1.5zM9.25 4.5A2.25 2.25 0 0 0 7 6.75V21h10V6.75A2.25 2.25 0 0 0 14.75 4.5h-5.5z"/></svg>
        Dashboard
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25V18.75A2.25 2.25 0 0 1 18.75 21H5.25A2.25 2.25 0 0 1 3 18.75V5.25zM5.25 4.5a.75.75 0 0 0-.75.75V9h15V5.25a.75.75 0 0 0-.75-.75H5.25z"/></svg>
        Roles
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 3.75A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6zM6 5.25h12a.75.75 0 0 1 .75.75v12a.75.75 0 0 1-.75.75H6a.75.75 0 0 1-.75-.75V6a.75.75 0 0 1 .75-.75z"/></svg>
        Applications
      </a>
      <a class="nav-btn" href="#">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 12a5.25 5.25 0 1 0 0-10.5A5.25 5.25 0 0 0 12 12zm-8.25 9a8.25 8.25 0 1 1 16.5 0V22.5h-16.5V21z"/></svg>
        Profile
      </a>
    </nav>

    <a class="beta-cta" href="https://aplyd.com/beta" target="_blank" rel="noopener">Sign up for Beta</a>
    <div class="small-note">Get early access and updates ‚ú®</div>
  </aside>

  <!-- ===== Content ===== -->
  <div style="display:flex;flex-direction:column;min-width:0">
    <header>
      <div class="hello">
        <div class="hi" role="status" aria-live="polite">Hi, Candidate üëã</div>
      </div>
      <div class="quick">
        <label class="chip">Agent Mode
          <input id="agentToggle" type="checkbox" aria-label="Toggle Agent Mode"/>
        </label>
        <div class="range">
          <label for="threshold"><b>Auto-apply ‚â•</b></label>
          <input id="threshold" type="range" min="50" max="100" step="1" />
          <span id="thresholdVal" class="chip" aria-live="polite">90</span>
        </div>
        <button class="btn primary" id="syncBtn">Refresh</button>
      </div>
    </header>

    <main>
      <!-- Hero -->
      <section class="card hero" aria-label="Intro">
        <h1>Find roles at top employers</h1>
        <p>Browse employers, inspect roles, and apply in a click. Aplyd keeps your pipeline tidy ‚Äî from approved to interview.</p>
      </section>

      <!-- Employers + Roles -->
      <section class="card section" aria-labelledby="employersHeading">
        <h2 id="employersHeading">
          Employers & roles
          <small><a href="#" id="clearFilters" style="color:var(--muted); text-decoration:none">Clear filters</a></small>
        </h2>

        <div class="toolbar" role="region" aria-label="Filters">
          <input class="input" id="q" placeholder="Search role title, employer‚Ä¶" aria-label="Search"/>
          <select id="loc" aria-label="Location filter">
            <option value="">All locations</option>
            <option>Remote</option>
            <option>Onsite</option>
            <option>Hybrid</option>
          </select>
          <select id="type" aria-label="Type filter">
            <option value="">Any type</option>
            <option>Full-time</option>
            <option>Contract</option>
            <option>Part-time</option>
            <option>Internship</option>
          </select>
          <select id="vis" aria-label="Visibility filter">
            <option value="">Visibility (any)</option>
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="draft">Draft</option>
          </select>
          <select id="resumePicker" aria-label="Default resume"></select>
        </div>

        <div class="panes">
          <!-- Employers -->
          <div class="card" style="padding:8px">
            <div class="list" id="employerList" role="listbox" aria-label="Employers"></div>
          </div>

          <!-- Roles -->
          <div>
            <div id="roleList" class="roles" aria-live="polite"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- ===== Apply Modal ===== -->
<dialog id="applyModal">
  <form method="dialog" class="modal" id="applyForm">
    <header>
      <h3 style="margin:0">Apply ‚Äî <span id="mTitle"></span> at <span id="mCompany" style="color:var(--muted)"></span></h3>
      <button class="btn" value="cancel" aria-label="Close">‚úï</button>
    </header>

    <div class="grid-2">
      <label>Full name
        <input class="input" id="mName" required placeholder="Your name"/>
      </label>
      <label>Email
        <input class="input" id="mEmail" type="email" required placeholder="you@email.com"/>
      </label>
    </div>

    <div class="grid-2">
      <label>Resume
        <select id="mResume" class="input" required></select>
      </label>
      <label>Cover Letter
        <select id="mHasCover" class="input">
          <option value="draft">Create draft</option>
          <option value="none">No cover letter</option>
        </select>
      </label>
    </div>

    <label>Cover Letter Text
      <textarea id="mCoverText" placeholder="Why you're a great fit‚Ä¶"></textarea>
    </label>

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" value="cancel">Cancel</button>
      <button id="applyConfirm" class="btn primary" value="apply">Apply</button>
    </div>
  </form>
</dialog>

<div id="toasts" class="toast" role="status" aria-live="polite"></div>

<script>
/* =============================
   Aplyd ‚Äî Roles & Employers
   Clean file, no backend needed
   ============================= */

/* ---------- Utilities ---------- */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const fmtMoney = (s) => s || "‚Äî";
const timeAgo = (ts) => {
  if (!ts) return "";
  const d = new Date(ts), diff = (Date.now() - d.getTime())/1000;
  const units = [["yr",31536000],["mo",2592000],["d",86400],["h",3600]];
  for (const [u,s] of units) if (diff >= s) return `${Math.floor(diff/s)} ${u} ago`;
  return "just now";
};
const level = (v)=> v>=90 ? "high" : v>=75 ? "med" : "low";
const svgBookmark = (on=false)=> on
  ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 2.25A2.25 2.25 0 0 0 3.75 4.5v17.25l8.25-4.5 8.25 4.5V4.5A2.25 2.25 0 0 0 18.75 2.25H6z"/></svg>'
  : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true"><path d="M6 2.25h12A2.25 2.25 0 0 1 20.25 4.5v17.25l-8.25-4.5-8.25 4.5V4.5A2.25 2.25 0 0 1 6 2.25z"/></svg>';
const toast = (msg) => {
  const host = $("#toasts");
  const div = document.createElement("div");
  div.className = "t";
  div.textContent = msg;
  host.appendChild(div);
  setTimeout(()=>div.remove(), 3200);
};
const escapeHtml = (s)=> (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

/* ---------- State ---------- */
const state = {
  resumes: [],
  employers: [],
  roles: [],
  applications: [], // {id, role_id, employer_id, status, fit_score, resume_id, applied_at, name, email, cover}
  bookmarks: new Set(JSON.parse(localStorage.getItem("aplyd.bookmarks")||"[]")),
  agent: JSON.parse(localStorage.getItem("aplyd.agent")||"false"),
  threshold: parseInt(localStorage.getItem("aplyd.threshold")||"90",10),
  selectedEmployer: null
};

/* ---------- Seed (mock data) ---------- */
function seedData(){
  state.resumes = [
    { id:"cv-1", title:"General Resume (PDF)", url:"#", created_at: new Date().toISOString() },
    { id:"cv-2", title:"Backend-leaning", url:"#", created_at: new Date(Date.now()-2*864e5).toISOString() },
  ];
  state.employers = [
    { id:"em-1", name:"Airtable",    slug:"airtable",    about:"Tools for connected apps.", color:"#3b82f6" },
    { id:"em-2", name:"Linear",      slug:"linear",      about:"Issue tracking re-imagined.", color:"#0b1220" },
    { id:"em-3", name:"Figma",       slug:"figma",       about:"Design for teams.", color:"#111827" },
    { id:"em-4", name:"Klarna",      slug:"klarna",      about:"Smoooth payments.", color:"#ef4444" },
    { id:"em-5", name:"Vercel",      slug:"vercel",      about:"Develop. Preview. Ship.", color:"#111827" },
  ];
  const now = Date.now();
  state.roles = [
    { id:"r-1", employer_id:"em-1", title:"Senior Backend Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$160‚Äì190k + equity", posted_at:new Date(now-8.6e6).toISOString(), tags:["Python","FastAPI","Postgres"] },
    { id:"r-2", employer_id:"em-5", title:"Frontend Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$150‚Äì180k", posted_at:new Date(now-2.2e7).toISOString(), tags:["React","Next.js","TypeScript"] },
    { id:"r-3", employer_id:"em-2", title:"Full-stack Engineer", location:"Hybrid", type:"Full-time", visibility:"public", salary:"$140‚Äì170k", posted_at:new Date(now-3.3e7).toISOString(), tags:["TypeScript","Node","GraphQL"] },
    { id:"r-4", employer_id:"em-3", title:"Design Systems Engineer", location:"Remote", type:"Contract", visibility:"private", salary:"$95‚Äì120/hr", posted_at:new Date(now-4.5e7).toISOString(), tags:["Web Components","TS","Accessibility"] },
    { id:"r-5", employer_id:"em-4", title:"Payments Platform Engineer", location:"Onsite", type:"Full-time", visibility:"draft", salary:"Competitive", posted_at:new Date(now-7.1e7).toISOString(), tags:["Java","Kafka","AWS"] },
    { id:"r-6", employer_id:"em-1", title:"Data Platform Engineer", location:"Remote", type:"Full-time", visibility:"public", salary:"$170‚Äì200k", posted_at:new Date(now-1.5e7).toISOString(), tags:["Python","Spark","Airflow"] },
    { id:"r-7", employer_id:"em-3", title:"Prod Infra Engineer", location:"Hybrid", type:"Full-time", visibility:"public", salary:"$160‚Äì185k", posted_at:new Date(now-8.8e6).toISOString(), tags:["Kubernetes","Go","Observability"] },
  ];

  // Load applications from localStorage, or create one example
  const saved = JSON.parse(localStorage.getItem("aplyd.applications")||"[]");
  state.applications = saved.length ? saved : [
    { id:"a-1", role_id:"r-2", employer_id:"em-5", status:"applied", fit_score:92, resume_id:"cv-2", applied_at:new Date().toISOString(), name:"", email:"", cover:"" }
  ];
}

/* ---------- Persistence ---------- */
function persist(){
  localStorage.setItem("aplyd.bookmarks", JSON.stringify([...state.bookmarks]));
  localStorage.setItem("aplyd.agent", JSON.stringify(state.agent));
  localStorage.setItem("aplyd.threshold", String(state.threshold));
  localStorage.setItem("aplyd.applications", JSON.stringify(state.applications));
}

/* ---------- Init ---------- */
(function init(){
  seedData();
  $("#agentToggle").checked = state.agent;
  $("#threshold").value = state.threshold;
  $("#thresholdVal").textContent = state.threshold;

  // events
  $("#threshold").addEventListener("input", e=>{
    state.threshold = +e.target.value;
    $("#thresholdVal").textContent = state.threshold;
    persist(); renderRoles();
  });
  $("#agentToggle").addEventListener("change", e=>{
    state.agent = e.target.checked; persist();
    toast(state.agent ? "Agent Mode enabled ‚úîÔ∏è" : "Agent Mode disabled");
    renderRoles();
  });
  $("#q").addEventListener("input", renderRoles);
  $("#loc").addEventListener("change", renderRoles);
  $("#type").addEventListener("change", renderRoles);
  $("#vis").addEventListener("change", renderRoles);
  $("#clearFilters").addEventListener("click", (e)=>{e.preventDefault(); $("#q").value=""; $("#loc").value=""; $("#type").value=""; $("#vis").value=""; renderRoles();});
  $("#syncBtn").addEventListener("click", ()=>{ renderAll(); toast("Refreshed ‚úîÔ∏è"); });

  renderAll();
})();

/* ---------- Rendering ---------- */
function renderAll(){
  renderResumePicker($("#resumePicker"));
  renderEmployers();
  renderRoles();
}

function renderResumePicker(selectEl){
  const opts = [`<option value="">Default resume‚Ä¶</option>`]
    .concat(state.resumes.map(r=>`<option value="${r.id}">${escapeHtml(r.title)}</option>`));
  selectEl.innerHTML = opts.join("");
  if (state.resumes[0]) selectEl.value = state.resumes[0].id;
}

function renderEmployers(){
  const host = $("#employerList");
  const counts = state.roles.reduce((m,r)=> (m[r.employer_id]=(m[r.employer_id]||0)+1, m), {});
  host.innerHTML = state.employers.map(e=>{
    const selected = state.selectedEmployer===e.id ? "selected" : "";
    return `<button class="row ${selected}" role="option" aria-selected="${selected?'true':'false'}" data-id="${e.id}" title="${escapeHtml(e.about)}">
      <span class="emblem" style="background:#eef7ff;color:#1849a9">${escapeHtml(e.name[0])}</span>
      <div style="display:grid">
        <b>${escapeHtml(e.name)}</b>
        <small>${escapeHtml(e.about)}</small>
      </div>
      <span class="count">${counts[e.id]||0}</span>
    </button>`;
  }).join("");

  $$("#employerList .row").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      state.selectedEmployer = state.selectedEmployer===id ? null : id;
      renderEmployers(); renderRoles();
    };
  });
}

function appByRole(roleId){ return state.applications.find(a=>a.role_id===roleId); }

function renderRoles(){
  renderResumePicker($("#mResume")); // keep modal picker fresh

  const q = ($("#q").value||"").toLowerCase();
  const loc = $("#loc").value;
  const type = $("#type").value;
  const vis = $("#vis").value;

  const activeEmployer = state.selectedEmployer;

  const roles = state.roles.filter(r=>{
    if (activeEmployer && r.employer_id!==activeEmployer) return false;
    if (q){
      const employer = state.employers.find(e=>e.id===r.employer_id)?.name || "";
      if (!(r.title+" "+employer).toLowerCase().includes(q)) return false;
    }
    if (loc && !(r.location||"").toLowerCase().includes(loc.toLowerCase())) return false;
    if (type && r.type!==type) return false;
    if (vis && r.visibility!==vis) return false;
    return true;
  });

  const host = $("#roleList");
  host.innerHTML = roles.map(r=>{
    const emp = state.employers.find(e=>e.id===r.employer_id);
    const app = appByRole(r.id);
    const isSaved = state.bookmarks.has(r.id);
    const score = app?.fit_score ?? guessFitScore(r);
    const lev = level(score);
    const status = app?.status;

    return `<article class="job" data-id="${r.id}" aria-label="${escapeHtml(r.title)} at ${escapeHtml(emp.name)}">
      <button class="save" title="${isSaved?'Saved':'Save'}" aria-pressed="${isSaved}">${svgBookmark(isSaved)}</button>

      <div class="company">
        <div class="emblem" style="background:#eef7ff;color:#1849a9">${escapeHtml(emp.name[0])}</div>
        <div class="title">
          <h4>${escapeHtml(emp.name)}</h4>
          <small>${escapeHtml(r.title)}</small>
        </div>
      </div>

      <div class="meta">
        <span>üìç ${escapeHtml(r.location)}</span>
        <span>üíº ${escapeHtml(r.type)}</span>
        <span>üïí ${timeAgo(r.posted_at)}</span>
        <span>üí∞ ${escapeHtml(fmtMoney(r.salary))}</span>
        ${r.visibility?`<span>üëÅÔ∏è ${escapeHtml(r.visibility)}</span>`:""}
      </div>

      <div>${r.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(" ")}</div>

      <div class="fit" data-level="${lev}">
        <div><b>Fit Score</b></div>
        <div class="score" aria-label="fit score">${score}</div>
        ${state.agent && score>=state.threshold ? '<span class="pill">Auto-apply eligible</span>' : ''}
      </div>

      ${status ? `<div class="status pill" data-s="${status}">${status}</div>` : ""}

      <div class="actions" style="display:flex;gap:8px">
        <button class="btn" data-action="approve">Approve</button>
        <button class="btn primary" data-action="apply" ${status==='applied'?'disabled':''}>
          ${status==='applied'?'Applied':'Apply'}
        </button>
      </div>
    </article>`;
  }).join("");

  // bindings
  $$("#roleList .save").forEach(btn=>{
    btn.onclick = (e)=>{
      const id = e.currentTarget.closest(".job").dataset.id;
      if (state.bookmarks.has(id)) state.bookmarks.delete(id); else state.bookmarks.add(id);
      persist(); renderRoles();
    };
  });
  $$("#roleList [data-action]").forEach(btn=>{
    btn.onclick = onRoleAction;
  });
}

/* ---------- Actions ---------- */
function onRoleAction(e){
  const action = e.currentTarget.dataset.action;
  const id = e.currentTarget.closest(".job").dataset.id;
  const role = state.roles.find(r=>r.id===id);
  const employer = state.employers.find(x=>x.id===role.employer_id);
  const app = appByRole(id);

  if (action==="approve"){
    if (app){ toast("Already in your pipeline."); return; }
    approveRole(role);
  }
  if (action==="apply"){
    openApplyModal(employer, role, app);
  }
}

function approveRole(role){
  const fit = guessFitScore(role);
  const a = {
    id: crypto.randomUUID?.() || "a-"+Math.random().toString(36).slice(2,9),
    role_id: role.id,
    employer_id: role.employer_id,
    status: "approved",
    fit_score: fit,
    resume_id: $("#resumePicker").value || state.resumes[0]?.id || null,
    applied_at: null,
    name:"",
    email:"",
    cover:""
  };
  state.applications.unshift(a);
  persist();
  renderRoles();
  toast("Approved ‚úîÔ∏è");

  if (state.agent && fit >= state.threshold){
    const emp = state.employers.find(e=>e.id===role.employer_id);
    openApplyModal(emp, role, a, /*auto*/ true);
  }
}

function openApplyModal(emp, role, app, auto=false){
  const dlg = $("#applyModal");
  $("#mCompany").textContent = emp.name;
  $("#mTitle").textContent = role.title;
  renderResumePicker($("#mResume"));
  $("#mHasCover").value = "draft";
  $("#mCoverText").value = coverDraft(emp, role);
  $("#mName").value = app?.name || "";
  $("#mEmail").value = app?.email || "";

  dlg.showModal();

  $("#applyConfirm").onclick = (ev)=>{
    ev.preventDefault();
    applyNow(emp, role, app);
  };

  if (auto){
    setTimeout(()=>applyNow(emp, role, app, true), 300);
  }
}

function applyNow(emp, role, existingApp, silent=false){
  const name = $("#mName").value.trim();
  const email = $("#mEmail").value.trim();
  const resume_id = $("#mResume").value || state.resumes[0]?.id;
  const wantCover = $("#mHasCover").value === "draft";
  const cover = wantCover ? $("#mCoverText").value.trim() : "";

  const base = existingApp || {
    id: crypto.randomUUID?.() || "a-"+Math.random().toString(36).slice(2,9),
    role_id: role.id,
    employer_id: emp.id,
    status:"approved",
    fit_score: guessFitScore(role),
    resume_id: resume_id,
    applied_at:null,
    name:"",
    email:"",
    cover:""
  };

  const patch = { ...base, status:"applied", applied_at:new Date().toISOString(), name, email, cover, resume_id };

  const idx = state.applications.findIndex(a=>a.id===base.id);
  if (idx>=0) state.applications[idx] = patch; else state.applications.unshift(patch);

  persist();
  renderRoles();
  $("#applyModal").close();
  if (!silent) toast(`Applied to ${emp.name} ‚Äî ${role.title} üéØ`);
}

/* ---------- Heuristics ---------- */
function guessFitScore(role){
  const t = (role.title||"").toLowerCase();
  let s = 62;
  if (t.includes("frontend")) s+=14;
  if (t.includes("backend")) s+=18;
  if (t.includes("full")) s+=10;
  if ((role.location||"").toLowerCase().includes("remote")) s+=8;
  if ((role.type||"").toLowerCase().includes("full")) s+=4;
  if (role.tags?.some(x=>/typescript|python|java|react|fastapi|graphql|kafka|kubernetes/i.test(x))) s+=6;
  return clamp(Math.round(s), 50, 99);
}

function coverDraft(emp, role){
  return `Dear Hiring Team at ${emp.name},

I'm excited to apply for the ${role.title} role. I have shipped production features across ${role.tags.slice(0,3).join(", ")} and love collaborating across product, design, and infra.

Highlights:
‚Ä¢ Built reliable services and focused on performance & DX.
‚Ä¢ Pragmatic, test-first approach; accessible, maintainable UI.
‚Ä¢ Comfortable with code reviews, pairing, and owning outcomes.

I'd be thrilled to bring that energy to ${emp.name}. Thanks for your time!

Best,
Candidate`;
}

/* ---------- Keyboard niceties ---------- */
document.addEventListener("keydown", (e)=>{
  if (e.key==="Escape") $("#applyModal")?.close?.();
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aplyd ‚Äî Swipe Jobs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="light dark" />
<style>
:root{
  /* Pastel, playful palette */
  --bg:#ffffff;
  --text:#0b1220;
  --muted:#6b7280;
  --line:#eaecef;
  --card:#ffffff;
  --pill:#f7f8fa;
  --shadow:0 6px 28px rgba(16,24,40,.08), 0 2px 8px rgba(16,24,40,.04);
  --primary-a:#40a9ff;   /* blue */
  --primary-b:#22c55e;   /* green */
  --neon:#c8ff3a;        /* glow */
  --pink:#ffd6e7;
  --mint:#d8ffec;
  --lav:#e6e2ff;
  --sky:#dff0ff;
  --sun:#fff3cd;

  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#ef4444;

  --radius:20px;
  --r-small:14px;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b1220;
    --text:#f8fafc;
    --muted:#9aa4b2;
    --line:#1f2937;
    --card:#0f172a;
    --pill:#0b1326;
    --shadow:0 8px 30px rgba(0,0,0,.35);
    --pink:#40283a; --mint:#203a33; --lav:#2a2742; --sky:#1a2a3a; --sun:#3a2f1a;
  }
}

*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  overflow-x:hidden;
}

/* Background blobs */
.blobs{
  position:fixed; inset:-10vmax -20vmax auto -20vmax; height:60vmax;
  pointer-events:none; z-index:0; filter: blur(30px) saturate(120%);
  background:
    radial-gradient(35vmax 30vmax at 20% 10%, var(--mint), transparent 60%),
    radial-gradient(38vmax 30vmax at 80% 0%, var(--sky), transparent 60%),
    radial-gradient(28vmax 24vmax at 50% 40%, var(--pink), transparent 60%),
    radial-gradient(28vmax 24vmax at 40% 80%, var(--lav), transparent 60%),
    radial-gradient(26vmax 20vmax at 70% 90%, var(--sun), transparent 60%);
  opacity:.9;
}

/* Header */
.header{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:16px 24px;
}
.brand{
  display:flex; align-items:center; gap:.5rem;
  font:800 24px ui-serif, Georgia, serif;
  letter-spacing:.3px;
}
.brand .dot{ color:var(--neon) }
.controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px;
  background:var(--pill); border:1px solid var(--line); font-weight:600; color:var(--muted);
}
.btn{
  border:1px solid var(--line); background:var(--card); color:inherit;
  padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700;
}
.btn.primary{
  border:none; color:#fff;
  background:linear-gradient(90deg,var(--primary-a),var(--primary-b));
  box-shadow:0 6px 18px rgba(34,197,94,.25), 0 2px 8px rgba(64,169,255,.22);
}

/* Canvas confetti sits on top */
#fx{ position:fixed; inset:0; z-index:7; pointer-events:none }

/* Layout */
.wrap{
  position:relative; z-index:1;
  display:grid; place-items:center;
  padding:10px 16px 26px;
}
.deck{
  width:min(820px, 96vw);
  height: min(76vh, 720px);
  position:relative;
}

/* Card stack */
.card{
  position:absolute; inset:0;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:grid; grid-template-rows:auto 1fr auto; gap:10px;
  user-select:none; touch-action:none;
  will-change:transform, opacity;
  transition:box-shadow .2s ease;
}
.card:hover{ box-shadow:0 12px 40px rgba(2,8,20,.14) }
.card .top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:18px 18px 8px 18px;
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; background:var(--pill); border:1px solid var(--line);
  border-radius:999px; font-weight:700;
}
.logo{
  width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
  font-weight:800; color:#1849a9; background:#eef7ff;
  flex: none;
}
.title{ display:grid }
.title h3{ margin:0; font-size:18px }
.title small{ color:var(--muted) }

/* Body */
.body{
  padding:8px 18px 0; overflow:auto;
}
.meta{ display:flex; flex-wrap:wrap; gap:10px; color:#4b5563; margin-bottom:6px }
.meta span{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  background:var(--pill); border:1px solid var(--line);
}
.tags{ display:flex; flex-wrap:wrap; gap:8px; }
.tag{ padding:6px 10px; border-radius:999px; font-weight:600;
  background:var(--pill); border:1px solid var(--line) }

.fit{
  display:flex; align-items:center; gap:10px; justify-content:space-between;
  padding:10px 12px; border:1px dashed var(--line); border-radius:12px; margin-top:10px;
  background: color-mix(in lab, var(--pill) 80%, transparent);
}
.score{ font:800 20px/1 Inter, system-ui }
.fit[data-lvl="high"] .score{ color:var(--ok) }
.fit[data-lvl="med"] .score{ color:var(--warn) }
.fit[data-lvl="low"] .score{ color:var(--bad) }

/* Footer actions */
.actions{
  display:flex; align-items:center; justify-content:center; gap:14px; padding:14px 18px 18px;
}
.circle{
  width:64px; height:64px; border-radius:50%;
  display:grid; place-items:center; font-size:22px; font-weight:900; cursor:pointer;
  border:1px solid var(--line); background:var(--card);
  transition:transform .08s ease, box-shadow .2s ease;
}
.circle:hover{ transform:translateY(-1px) }
.circle.pass{ background:var(--pink) }
.circle.save{ background:var(--lav) }
.circle.like{ background:var(--mint) }

/* Stack transforms ‚Äî each deeper card is slightly scaled/rotated */
.card:nth-last-child(1){ transform:translate(0,0) rotate(0deg) }
.card:nth-last-child(2){ transform:translate(0,6px) rotate(-1deg) scale(.996) }
.card:nth-last-child(3){ transform:translate(0,12px) rotate(1deg)  scale(.992) }
.card.leave{ pointer-events:none }

/* Toasts & bottom tray */
.toast{ position:fixed; right:18px; bottom:18px; display:grid; gap:8px; z-index:9 }
.toast .t{
  background:#0b1220; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow);
  animation:slideIn .2s ease-out;
}
@keyframes slideIn{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

.tray{
  width:min(920px, 96vw);
  margin:8px auto 22px;
  display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px;
}
.chiprow{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--r-small); padding:10px 12px;
}
.chiprow .pill{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:700 }

/* Search bar */
.searchbar{
  width:min(920px, 96vw);
  margin:6px auto 0;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;
}
.input, select{
  border:1px solid var(--line); background:var(--card); color:inherit;
  padding:10px 12px; border-radius:12px; min-width:160px;
}
.range{ display:flex; align-items:center; gap:8px }
kbd{ background:var(--pill); border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-weight:700; font-size:12px }

@media (max-width:760px){
  .deck{ height:72vh }
  .circle{ width:60px; height:60px }
  .header{ padding:14px 14px }
}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="blobs" aria-hidden="true"></div>

<header class="header">
  <div class="brand">Aplyd<span class="dot">‚Ä¢</span></div>
  <div class="controls">
    <span class="chip">Agent <input id="agentToggle" type="checkbox" aria-label="Toggle Agent Mode"></span>
    <div class="chip range">
      Auto-apply ‚â• <input id="threshold" type="range" min="50" max="100" step="1">
      <b id="thv">90</b>
    </div>
    <button class="btn primary" id="resetBtn">Reset Deck</button>
  </div>
</header>

<section class="searchbar" aria-label="Filters">
  <input class="input" id="q" placeholder="Search title or employer‚Ä¶">
  <select id="loc">
    <option value="">All locations</option>
    <option>Remote</option>
    <option>Onsite</option>
    <option>Hybrid</option>
  </select>
  <select id="type">
    <option value="">Any type</option>
    <option>Full-time</option>
    <option>Contract</option>
    <option>Part-time</option>
  </select>
  <div class="chip">Tips: <kbd>‚Üê</kbd> pass <kbd>‚Üí</kbd> like <kbd>S</kbd> save</div>
</section>

<main class="wrap">
  <div class="deck" id="deck" aria-live="polite"></div>
</main>

<section class="tray" aria-label="Pipeline">
  <div class="chiprow" id="appliedRow"><b>Applied</b></div>
  <div class="chiprow" id="savedRow"><b>Saved</b></div>
  <div class="chiprow" id="passedRow"><b>Passed</b></div>
</section>

<div id="toasts" class="toast" role="status" aria-live="polite"></div>

<script>
/* ============== Data (mock) ============== */
const EMPLOYERS = [
  { id:"em-1", name:"Airtable", color:"#3b82f6", about:"Tools for connected apps." },
  { id:"em-2", name:"Linear", color:"#0b1220", about:"Issue tracking re-imagined." },
  { id:"em-3", name:"Figma", color:"#111827", about:"Design for teams." },
  { id:"em-4", name:"Klarna", color:"#ef4444", about:"Smoooth payments." },
  { id:"em-5", name:"Vercel", color:"#111827", about:"Develop. Preview. Ship." },
];
const ROLES = [
  { id:"r-1", employer_id:"em-1", title:"Senior Backend Engineer", location:"Remote", type:"Full-time", salary:"$160‚Äì190k + equity", posted_at: Date.now()-8.6e6, tags:["Python","FastAPI","Postgres","AWS"] },
  { id:"r-2", employer_id:"em-5", title:"Frontend Engineer", location:"Remote", type:"Full-time", salary:"$150‚Äì180k", posted_at: Date.now()-2.2e7, tags:["React","Next.js","TypeScript","Vercel"] },
  { id:"r-3", employer_id:"em-2", title:"Full-stack Engineer", location:"Hybrid", type:"Full-time", salary:"$140‚Äì170k", posted_at: Date.now()-3.3e7, tags:["TS","Node","GraphQL","Prisma"] },
  { id:"r-4", employer_id:"em-3", title:"Design Systems Engineer", location:"Remote", type:"Contract", salary:"$95‚Äì120/hr", posted_at: Date.now()-4.5e7, tags:["Web Components","A11y","TS"] },
  { id:"r-5", employer_id:"em-4", title:"Payments Platform Engineer", location:"Onsite", type:"Full-time", salary:"Competitive", posted_at: Date.now()-7.1e7, tags:["Java","Kafka","AWS"] },
  { id:"r-6", employer_id:"em-1", title:"Data Platform Engineer", location:"Remote", type:"Full-time", salary:"$170‚Äì200k", posted_at: Date.now()-1.5e7, tags:["Python","Spark","Airflow","DBT"] },
  { id:"r-7", employer_id:"em-3", title:"Prod Infra Engineer", location:"Hybrid", type:"Full-time", salary:"$160‚Äì185k", posted_at: Date.now()-8.8e6, tags:["Go","Kubernetes","Observability"] },
];

/* ============== State ============== */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
const clamp = (n,a,b)=> Math.max(a,Math.min(b,n));
const state = {
  q:"",
  loc:"",
  type:"",
  cards:[],
  applied:new Map(JSON.parse(localStorage.getItem("aplyd.applied")||"[]")),
  saved:new Map(JSON.parse(localStorage.getItem("aplyd.saved")||"[]")),
  passed:new Map(JSON.parse(localStorage.getItem("aplyd.passed")||"[]")),
  agent: JSON.parse(localStorage.getItem("aplyd.agent")||"false"),
  threshold: parseInt(localStorage.getItem("aplyd.threshold")||"90",10),
};
function persist(){
  localStorage.setItem("aplyd.applied", JSON.stringify([...state.applied]));
  localStorage.setItem("aplyd.saved", JSON.stringify([...state.saved]));
  localStorage.setItem("aplyd.passed", JSON.stringify([...state.passed]));
  localStorage.setItem("aplyd.agent", JSON.stringify(state.agent));
  localStorage.setItem("aplyd.threshold", String(state.threshold));
}

/* ============== Helpers ============== */
function employerBy(id){ return EMPLOYERS.find(e=>e.id===id) }
function timeAgo(ts){
  const diff = (Date.now() - ts)/1000;
  const u = [["yr",31536000],["mo",2592000],["d",86400],["h",3600]];
  for (const [k,s] of u) if (diff>=s) return `${Math.floor(diff/s)} ${k} ago`;
  return "just now";
}
function guessFit(role){
  const t = role.title.toLowerCase();
  let s = 62;
  if (t.includes("frontend")) s+=14;
  if (t.includes("backend")) s+=18;
  if (t.includes("full")) s+=10;
  if (role.location.toLowerCase().includes("remote")) s+=8;
  if (role.tags.some(x=>/typescript|python|java|react|fastapi|graphql|kafka|kubernetes|spark/i.test(x))) s+=6;
  return clamp(Math.round(s), 50, 99);
}
function level(v){ return v>=90 ? "high" : v>=75 ? "med" : "low" }
function toast(msg){
  const host = $("#toasts"); const d = document.createElement("div");
  d.className="t"; d.textContent=msg; host.appendChild(d);
  setTimeout(()=>d.remove(), 3000);
}

/* ============== Confetti FX ============== */
const fx = $("#fx"); const ctx = fx.getContext("2d");
let particles=[];
function resizeFx(){ fx.width=innerWidth; fx.height=innerHeight }
addEventListener("resize", resizeFx); resizeFx();
function confetti(x, y, n=80){
  for(let i=0;i<n;i++){
    particles.push({
      x, y, r: Math.random()*4+2,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*-4-2,
      color: ["#22c55e","#40a9ff","#c8ff3a","#ffd6e7","#e6e2ff"][i%5],
      life: 60+Math.random()*30
    });
  }
}
function tick(){
  ctx.clearRect(0,0,fx.width,fx.height);
  particles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.life--;
    ctx.fillStyle=p.color; ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  particles = particles.filter(p=>p.life>0);
  requestAnimationFrame(tick);
}
tick();

/* ============== Build deck ============== */
function filters(role){
  if (state.q){
    const e = employerBy(role.employer_id).name.toLowerCase();
    if (!(role.title+" "+e).toLowerCase().includes(state.q)) return false;
  }
  if (state.loc && role.location!==state.loc) return false;
  if (state.type && role.type!==state.type) return false;
  if (state.passed.has(role.id)) return false; // keep passed out of deck
  if (state.applied.has(role.id)) return false; // hide applied too
  return true;
}

function renderDeck(){
  const deck = $("#deck"); deck.innerHTML="";
  const roles = ROLES.filter(filters);
  // top 6 only to keep DOM light
  const stack = roles.slice(0,6);
  state.cards = [];
  stack.forEach((r,i)=> deck.appendChild(makeCard(r, i)));
  renderTray();
}

function makeCard(role){
  const emp = employerBy(role.employer_id);
  const fit = guessFit(role);
  const card = document.createElement("article");
  card.className="card";
  card.setAttribute("data-id", role.id);
  card.innerHTML = `
    <div class="top">
      <div style="display:flex; align-items:center; gap:12px">
        <div class="logo" aria-hidden="true" style="background:#eef7ff;color:#1849a9">${emp.name[0]}</div>
        <div class="title">
          <h3>${emp.name}</h3>
          <small>${role.title}</small>
        </div>
      </div>
      <div class="badge">‚≠ê ${fit} fit</div>
    </div>
    <div class="body">
      <div class="meta">
        <span>üìç ${role.location}</span>
        <span>üíº ${role.type}</span>
        <span>üïí ${timeAgo(role.posted_at)}</span>
        <span>üí∞ ${role.salary}</span>
      </div>
      <div class="tags">${role.tags.map(t=>`<span class="tag">${t}</span>`).join("")}</div>
      <div class="fit" data-lvl="${level(fit)}">
        <div><b>Fit Score</b></div>
        <div class="score">${fit}</div>
        ${state.agent && fit>=state.threshold ? '<span class="tag">Auto-apply eligible</span>' : ''}
      </div>
    </div>
    <div class="actions">
      <button class="circle pass"  data-act="pass"  title="Pass üëã">üëã</button>
      <button class="circle save"  data-act="save"  title="Save ‚≠ê">‚≠ê</button>
      <button class="circle like"  data-act="like"  title="Like üíö">üíö</button>
    </div>
  `;
  enableDrag(card, role);
  card.querySelectorAll("[data-act]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const box = card.getBoundingClientRect();
      if (btn.dataset.act==="pass") go(card, -1, box);
      if (btn.dataset.act==="save") { doSave(role); pulse(btn); }
      if (btn.dataset.act==="like") go(card, 1, box, true);
    });
  });
  return card;
}

function pulse(el){
  el.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:160});
}

/* Drag / Swipe */
function enableDrag(card, role){
  let start=null, current={x:0,y:0}, pointerId=null;
  const DECAY = 0.35, ROT= 12; const thresh = 120;

  const onDown = (e)=>{
    if (pointerId!==null) return;
    pointerId = e.pointerId || 1;
    card.setPointerCapture?.(pointerId);
    start = { x: e.clientX, y: e.clientY };
  };
  const onMove = (e)=>{
    if (!start) return;
    current = { x: e.clientX - start.x, y: e.clientY - start.y };
    const rot = (current.x / innerWidth) * ROT;
    card.style.transform = `translate(${current.x}px, ${current.y}px) rotate(${rot}deg)`;
    // Affordance color via box-shadow
    const like = Math.sign(current.x) > 0;
    card.style.boxShadow = like
      ? "0 18px 60px rgba(34,197,94,.25), 0 6px 18px rgba(64,169,255,.22)"
      : "0 18px 60px rgba(239,68,68,.20), 0 6px 18px rgba(255,99,99,.18)";
  };
  const onUp = (e)=>{
    if (!start) return;
    const dx = current.x;
    const dir = Math.abs(dx) > thresh ? Math.sign(dx) : 0;
    const rect = card.getBoundingClientRect();
    if (dir!==0){
      go(card, dir, rect, dir>0);
    }else{
      card.style.transition = "transform .18s ease";
      card.style.transform = "translate(0,0) rotate(0)";
      setTimeout(()=>{ card.style.transition=""; card.style.boxShadow="var(--shadow)"; }, 180);
    }
    start=null; pointerId=null;
  };

  card.addEventListener("pointerdown", onDown);
  addEventListener("pointermove", onMove);
  addEventListener("pointerup", onUp);
  addEventListener("pointercancel", onUp);

  function go(el, dir, rect, liked=false){
    el.classList.add("leave");
    const offX = dir>0 ? innerWidth : -innerWidth;
    el.style.transition = "transform .28s ease, opacity .28s ease";
    el.style.transform = `translate(${offX}px, ${rect.y - innerHeight*0.15}px) rotate(${dir*18}deg)`;
    el.style.opacity = 0;
    setTimeout(()=>{ el.remove(); renderTray(); if (!liked){ doPass(role); } else { doLike(role, rect); } nextAutoApply(role, liked);}, 260);
  }
}

function doPass(role){
  state.passed.set(role.id, role.title); persist();
  toast(`Passed ${employerBy(role.employer_id).name} ‚Äì ${role.title} üëã`);
  addChip($("#passedRow"), role, "üëã");
  // Pull in next card if available
  renderDeck();
}
function doSave(role){
  state.saved.set(role.id, role.title); persist();
  toast(`Saved ${employerBy(role.employer_id).name} ‚Äì ${role.title} ‚≠ê`);
  addChip($("#savedRow"), role, "‚≠ê");
}
function doLike(role, rect){
  state.applied.set(role.id, role.title); persist();
  toast(`Applied to ${employerBy(role.employer_id).name} ‚Äì ${role.title} üéØ`);
  addChip($("#appliedRow"), role, "üíö");
  confetti(rect?.x + rect?.width/2 || innerWidth/2, rect?.y + 60 || innerHeight/2, 90);
  renderDeck();
}

function nextAutoApply(role, liked){
  // Agent Mode: if fit‚â•threshold and user swiped pass by mistake? We'll only auto-apply on like.
  if (!state.agent) return;
  const fit = guessFit(role);
  if (liked && fit >= state.threshold){
    // nothing extra ‚Äî like already applied
  }
}

/* ============== Tray chips ============== */
function addChip(row, role, icon){
  const emp = employerBy(role.employer_id);
  const chip = document.createElement("span");
  chip.className="pill";
  chip.textContent = `${icon} ${emp.name} ‚Äî ${role.title}`;
  row.appendChild(chip);
}
function renderTray(){
  const appliedRow=$("#appliedRow"), savedRow=$("#savedRow"), passedRow=$("#passedRow");
  [appliedRow, savedRow, passedRow].forEach(r=>{
    r.innerHTML = "<b>"+r.firstChild.textContent+"</b>";
  });
  state.applied.forEach((_,id)=>{
    const r = ROLES.find(x=>x.id===id); if (r) addChip(appliedRow, r, "üíö");
  });
  state.saved.forEach((_,id)=>{
    const r = ROLES.find(x=>x.id===id); if (r) addChip(savedRow, r, "‚≠ê");
  });
  state.passed.forEach((_,id)=>{
    const r = ROLES.find(x=>x.id===id); if (r) addChip(passedRow, r, "üëã");
  });
}

/* ============== Wiring ============== */
function bindFilters(){
  $("#q").addEventListener("input", e=>{ state.q = e.target.value.trim().toLowerCase(); renderDeck(); });
  $("#loc").addEventListener("change", e=>{ state.loc = e.target.value; renderDeck(); });
  $("#type").addEventListener("change", e=>{ state.type = e.target.value; renderDeck(); });
  $("#resetBtn").addEventListener("click", ()=>{
    state.passed.clear(); state.applied.clear(); state.saved.clear(); persist();
    renderDeck(); renderTray(); toast("Deck reset ‚úîÔ∏è");
  });

  // Agent toggles
  $("#agentToggle").checked = state.agent;
  $("#agentToggle").addEventListener("change", e=>{
    state.agent = e.target.checked; persist();
    toast(state.agent ? "Agent Mode enabled ‚úîÔ∏è" : "Agent Mode disabled");
    renderDeck();
  });
  $("#threshold").value = state.threshold; $("#thv").textContent = state.threshold;
  $("#threshold").addEventListener("input", e=>{
    state.threshold = +e.target.value; $("#thv").textContent = state.threshold; persist(); renderDeck();
  });

  // Keyboard shortcuts
  addEventListener("keydown", e=>{
    const top = $("#deck .card:last-child"); if (!top) return;
    const box = top.getBoundingClientRect();
    const role = ROLES.find(r=>r.id===top.dataset.id);
    if (e.key==="ArrowLeft"){ top.querySelector('[data-act="pass"]').click(); }
    if (e.key==="ArrowRight"){ top.querySelector('[data-act="like"]').click(); }
    if (e.key.toLowerCase()==="s"){ top.querySelector('[data-act="save"]').click(); }
    if (e.key===" "){ e.preventDefault(); top.querySelector('[data-act="like"]').click(); }
  }, {passive:false});
}

/* ============== Kickoff ============== */
bindFilters();
renderDeck();
</script>
</body>
</html>
